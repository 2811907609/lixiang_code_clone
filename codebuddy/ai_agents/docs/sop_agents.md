# SOP Agents：标准化操作流程驱动的智能体系统

## 核心理念

SOP Agents 是一个基于标准化操作流程（Standard Operating Procedures）的智能体架构系统。它的核心理念是将复杂的软件开发任务分解为标准化的工作流程，通过监督智能体（Supervisor Agent）协调多个专业化的微智能体（Micro Agent）来完成任务。

### 设计哲学

**标准化驱动**：每个智能体都遵循明确定义的 SOP 工作流程，确保任务执行的一致性和可预测性。

**分层协作**：采用监督者-执行者的分层架构，监督智能体负责任务协调和决策，微智能体专注于特定技术领域的执行。

**专业化分工**：每个微智能体都专注于特定的技术能力，如代码分析、测试生成、文件操作等，通过专业化提高执行效率。

**可组合性**：智能体可以灵活组合，根据不同任务需求动态配置智能体团队。

## 架构设计

### 三层架构

```
┌─────────────────────────────────────┐
│           CLI Interface             │  用户交互层
├─────────────────────────────────────┤
│        Supervisor Agent             │  监督协调层
├─────────────────────────────────────┤
│    Micro Agents + Tools + SOP      │  执行能力层
└─────────────────────────────────────┘
```

### 核心组件

**监督智能体（Supervisor Agent）**

- 继承自 `BaseSupervisorAgent` 类
- 负责任务分解、智能体协调和结果整合
- 通过 `_get_enhanced_task()` 方法将 SOP 流程注入任务描述
- 使用 `_get_tools()` 方法配置可用的微智能体和工具

**微智能体（Micro Agent）**

- 继承自 `BaseMicroAgent` 类
- 专注于特定技术领域的能力提供
- 通过 `agent_as_tool()` 方法将自身包装为工具供监督智能体使用
- 可以通过 YAML 配置实现快速定制

**SOP 工作流程（SOP Workflow）**

- 存储在 `ai_agents/sop_workflows/` 目录下
- 每个类别包含 `sop.md.j2`（Jinja2 模板）或 `sop.md`（普通 Markdown）主文件和可选的辅助文件
- 支持 Jinja2 模板语法，可以使用 `{% include %}` 等功能组合多个文件
- 通过 `sop_manager.py` 中的 `get_sop()` 函数动态加载和渲染

## SOP 工作流程系统

### SOP 的作用

SOP（标准操作流程）是 SOP Agents 系统的核心驱动力。它定义了智能体应该如何执行特定类型的任务，包括：

- **工作步骤**：明确的任务执行顺序
- **协作原则**：智能体之间的协作规范
- **质量标准**：任务完成的验收标准
- **最佳实践**：经过验证的执行方法

### SOP 管理

SOP 系统通过 `SOPManager` 类进行统一管理：

- `get_available_sop_categories()`：获取所有可用的 SOP 类别
- `get_sop(category)`：获取指定类别的完整 SOP 内容，支持 Jinja2 模板渲染
- `get_sop_additional_file(category, filename)`：获取 SOP 的辅助文件

### SOP 模板系统

SOP 系统支持 Jinja2 模板功能，提供更强大的内容组织能力：

**文件优先级**：

1. `sop.md.j2` - Jinja2 模板文件（优先使用）
2. `sop.md` - 普通 Markdown 文件（向后兼容）

**模板功能**：

- **文件包含**：使用 `{% include 'filename.md' %}` 包含同目录下的其他文件
- **内容复用**：将通用内容抽取到独立文件中，在多个 SOP 中复用
- **动态组合**：根据需要灵活组合不同的指导内容

**使用示例**：

```jinja2
你是一个编程专家，请帮助用户完成他的任务。

{% include 'common_instructions.md' %}

{% include 'specific_guidelines.md' %}
```

### SOP 集成机制

监督智能体通过 `_get_enhanced_task()` 方法将 SOP 内容自动注入到任务描述中，确保智能体严格按照标准流程执行任务。

## 微智能体生态

### 专业化微智能体

系统提供了多种专业化的微智能体：

- **代码分析智能体**：负责代码结构分析和理解
- **测试生成智能体**：专门生成和执行测试用例
- **搜索智能体**：提供代码搜索和定位能力
- **单元测试智能体**：专注于单元测试的创建和维护

### YAML 配置化智能体

通过 `YamlAgentFactory` 类，可以使用 YAML 配置快速创建定制化的微智能体：

```yaml
name: "custom_agent"
description: "自定义智能体描述"
tools:
  - name: "tool_name"
    module: "module.path"
    function: "function_name"
agent_tool:
  enabled: true
  function_name: "custom_query"
  description: "智能体工具描述"
```

### 智能体即工具（Agent as Tool）

微智能体可以通过 `agent_as_tool()` 方法将自身包装为工具，供监督智能体调用。这种设计实现了：

- **能力封装**：将复杂的智能体能力封装为简单的工具接口
- **动态组合**：监督智能体可以根据需要动态选择和组合微智能体
- **标准化接口**：所有微智能体都提供统一的工具接口

## 实际应用场景

### SWE-Bench 任务处理

在 SWE-Bench 场景中，SOP Agents 展现了强大的协作能力：

1. **AnalysisAgent** 负责问题理解和方案设计
2. **TestAgent** 负责测试执行和验证
3. **CodeOperationAgent** 负责代码搜索和修改
4. **监督智能体** 协调整个修复流程

### 代码审查流程

在代码审查场景中：

1. **代码分析智能体** 分析代码结构和质量
2. **测试覆盖率智能体** 检查测试覆盖情况
3. **安全审查智能体** 进行安全漏洞检测
4. **监督智能体** 整合审查结果并生成报告

## 技术优势

### 可扩展性

- **模块化设计**：新的微智能体可以轻松集成到现有系统
- **SOP 可配置**：可以为不同场景定制专门的 SOP 流程
- **工具生态**：丰富的工具库支持各种技术需求

### 可维护性

- **标准化接口**：统一的基类和接口设计
- **清晰分工**：每个组件职责明确，便于维护和调试
- **配置驱动**：通过配置文件而非代码修改来调整行为

### 可靠性

- **流程标准化**：SOP 确保任务执行的一致性
- **分步验证**：每个步骤都有明确的验证机制
- **错误隔离**：微智能体的错误不会影响整个系统

## 开发指南

### 创建新的监督智能体

1. 继承 `BaseSupervisorAgent` 类
2. 实现必要的抽象方法（`name`、`sop_category` 等）
3. 在 `_get_tools()` 方法中配置微智能体
4. 创建对应的 SOP 工作流程文件

### 创建新的微智能体

1. 继承 `BaseMicroAgent` 类
2. 实现抽象方法（`name`、`description`、`_get_tools` 等）
3. 通过 `agent_as_tool()` 方法提供工具接口
4. 或使用 YAML 配置快速创建

### 定义 SOP 工作流程

1. 在 `ai_agents/sop_workflows/` 下创建新目录
2. 编写 `sop.md` 主文件，定义详细的工作流程
3. 添加必要的辅助文件（如示例、模板等）
4. 通过 `get_sop()` 函数在智能体中使用

## 未来发展

SOP Agents 系统将继续朝着更加智能化、自动化的方向发展：

- **自适应 SOP**：根据任务执行结果自动优化 SOP 流程
- **智能体学习**：微智能体可以从历史执行中学习和改进
- **跨领域协作**：支持更复杂的跨技术领域任务协作
- **可视化管理**：提供图形化的 SOP 设计和监控界面

通过 SOP Agents 系统，我们实现了一个既标准化又灵活的智能体协作框架，为复杂软件开发任务的自动化处理提供了强有力的支持。
